<!DOCTYPE HTML>
<html>
  <head>
    <title>fabric-patch</title>
    <!-- script type="text/javascript" src="js/graphlet/graphlet_query.js"></script>
    <script type="text/javascript" src="js/graphlet/graphlet_procedural_run.js"></script -->
    <script type="text/javascript" src="js/chroma.min.js"></script>
  </head>
  <body>
    <canvas id="thePatches" width="1200" height="600"></canvas>
    <button id="toggle">pick</button>
    <canvas id="theColors" width="1200" height="50"></canvas>
	<div class="footer"><small>V_0.0.0.0 (got to start somewhere)</small></div>
    <script>
    var canvas = document.getElementById('thePatches');
    var cx = canvas.getContext('2d');
    var palette = document.getElementById('theColors');
    var px = palette.getContext('2d');
    var last_color = chroma('red');
    var last_p_pos = {x:-200, y:-200};
    var last_p_color = null;
    cx.beginPath();
    cx.fillStyle = "#FFFFFF";
    cx.rect(0, 0, canvas.width, canvas.height);
    cx.fill();
    px.beginPath();
    px.fillStyle = "#FFFFFF";
    px.rect(0, 0, palette.width, palette.height);
    px.fill();

    function getMousePos(canvas, evt) {
      var rect = canvas.getBoundingClientRect();
      return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
      };
    }

    canvas.addEventListener('click', function(evt) {
      var mousePos = getMousePos(canvas, evt);
//      var color_at = get_color(mousePos.x, mousePos.y);
      last_p_color = chroma.mix(last_p_color, last_color, 0.5, 'lab');
      setPatch(mousePos.x, mousePos.y, last_p_color);

    }, false);

    canvas.addEventListener('mousemove', function(evt) {
      var mousePos = getMousePos(canvas, evt);
      var color_at;
      var p_pos = getPatchXY(mousePos.x, mousePos.y);
      if (last_p_pos.x !== p_pos.x || last_p_pos.y !== p_pos.y) {
        // replace the old color
        if (last_p_color) {
          setPatch(last_p_pos.x, last_p_pos.y, chroma(last_p_color));
        }
        last_p_pos = p_pos;
        last_p_color = get_color(mousePos.x, mousePos.y);
        color_at = get_color(mousePos.x, mousePos.y);
        setPatch(mousePos.x, mousePos.y, chroma.mix(color_at, last_color, 0.5, 'lab'));
      }
    }, false);

    palette.addEventListener('click', function(evt) {
      var mousePos = getMousePos(palette, evt);
      last_color = get_color(mousePos.x, mousePos.y, px);
    }, false);

    function setPatch(x, y, color, granular, context) {
    	var size = granular || 100;
    	var ctx = context || cx;
      x = Math.floor(x/size) * size;
      y = Math.floor(y/size) * size;
      ctx.beginPath();
      ctx.rect(x, y, size, size);
      ctx.fillStyle = color;
      ctx.fill();
    }
    function getPatchXY(x, y, granular) {
    	var size = granular || 100;
      x = Math.floor(x/size) * size;
      y = Math.floor(y/size) * size;
      return {x:x, y:y};
    }
      function isSteppedOn(x, y) {
        var p = cx.getImageData(x, y, 1, 1).data;
        if (p[0] < 255 && p[1] < 255 && p[2] < 255) {
          return true;
        }
        return false;
      }
      function get_color(x, y, context) {
      	var ctx = context || cx;
        var p = colorAt(x, y, ctx);

        var color = chroma(p, 'rgb');
        return color;
      }

      function colorAt(x, y, ctx) {
        var p = ctx.getImageData(x, y, 1, 1).data;
        return p;
      }
      function setup_palette () {
      	var i = 0;
      	var color_array = chroma.scale(['red', 'orange', 'yellow','green','blue', 'purple', 'red']).colors(13);
      	for(i = 0; i < 12; i = i + 1) {
      		setPatch(i * 10, 1, color_array[i], 10, px);
      	}
      	setPatch(i * 10, 1, chroma('black'), 10, px);
      }

      setup_palette();
    </script>
  </body>
</html>
